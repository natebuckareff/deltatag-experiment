import fs from 'node:fs';
import path from 'node:path';
import { glob } from 'glob';

const buildDir = '.build';
const outputDir = '.output';

function findProjectRoot() {
  let current = process.cwd();
  while (true) {
    const packageJson = path.join(current, 'package.json');
    if (fs.existsSync(packageJson)) {
      return current;
    }
    if (current === '/') {
      throw new Error('project root not found');
    }
    current = path.resolve(current, '..');
  }
}

const root = findProjectRoot();
const pages = glob.sync(path.join(root, 'src/**/*.page.tsx'));

const imports = pages
  .map((page, i) => {
    const relative = path.relative(buildDir, page);
    return `import * as Page${i} from ${JSON.stringify(relative)};`;
  })
  .join('\n');

const pagesArray = pages
  .map((page, i) => {
    const file = page.slice(root.length + 1);
    return `{ file: ${JSON.stringify(file)}, module: Page${i} }`;
  })
  .join(',\n  ');

// TODO: this file will eventually live in node_modules or something
const buildImportPath = path.join(root, 'src/scripts/build.tsx');

const code = `// DO NOT EDIT
// This file was generated by prebuild.ts

import { renderToString } from "solid-js/web";
import fs from "node:fs";
import path from "node:path";
import { build } from ${JSON.stringify(buildImportPath)};

${imports}

const pages = [
  ${pagesArray}
];

const projectRoot = path.resolve(import.meta.dirname, '../..');
const outDir = path.join(projectRoot, '${outputDir}');

build({ pages, projectRoot, outDir });
`;

const serverEntryPath = path.join(root, buildDir, 'entry-server.tsx');
fs.mkdirSync(path.dirname(serverEntryPath), { recursive: true });
fs.writeFileSync(serverEntryPath, code);

console.log('âœ“ generated', path.relative(root, serverEntryPath));
